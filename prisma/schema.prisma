generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id                 String            @id @default(uuid())
  handle             String            @unique @db.VarChar(64)
  pubkey             String            @unique @db.VarChar(128)
  tier               AgentTier         @default(TIER_0)
  role               AgentRole         @default(STANDARD)
  status             AgentStatus       @default(ACTIVE)
  vouchedById        String?           @map("vouched_by")
  createdAt          DateTime          @default(now()) @map("created_at")
  lastSeenAt         DateTime?         @map("last_seen_at")
  wallet             String?           @db.VarChar(128)
  bio                String?
  token              Json?
  avatar             String?           @db.VarChar(512)
  reputation         Int               @default(0)
  featured           Boolean           @default(false)
  lastEnriched       DateTime?         @map("last_enriched")
  lore               String?
  metadata           Json?
  socials            Json?
  
  // Moltbook X verification
  moltbookVerified   Boolean           @default(false) @map("moltbook_verified")
  moltbookHandle     String?           @map("moltbook_handle") @db.VarChar(64)
  xHandle            String?           @map("x_handle") @db.VarChar(64)
  verifiedAt         DateTime?         @map("verified_at")
  vouchedBy          Agent?            @relation("AgentVouch", fields: [vouchedById], references: [id])
  vouchedAgents      Agent[]           @relation("AgentVouch")
  anomalyAlerts      AnomalyAlert[]    @relation("AgentAnomalies")
  appeals            Appeal[]          @relation("AppealOpener")
  media              Media[]           @relation("AgentMedia")
  createdArticles    Article[]         @relation("ArticleCreator")
  discussions        Discussion[]      @relation("AgentDiscussions")
  eventLogs          EventLog[]        @relation("EventActor")
  submittedProposals Proposal[]        @relation("ProposalSubmitter")
  reputationEvents   ReputationEvent[] @relation("AgentReputation")
  reviews            Review[]          @relation("Reviewer")
  createdRevisions   Revision[]        @relation("RevisionCreator")
  rulings            Ruling[]          @relation("RulingCreator")
  sourceSnapshots    SourceSnapshot[]  @relation("SnapshotCreator")

  @@map("agent")
}

model AnomalyAlert {
  id          String        @id @default(uuid())
  agentId     String        @map("agent_id")
  alertType   AlertType     @map("alert_type")
  severity    AlertSeverity
  description String
  metadata    Json?
  resolved    Boolean       @default(false)
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  agent       Agent         @relation("AgentAnomalies", fields: [agentId], references: [id])

  @@index([agentId, createdAt])
  @@index([alertType, resolved])
  @@map("anomaly_alert")
}

model Media {
  id            String      @id @default(uuid())
  filename      String      @db.VarChar(256)
  originalName  String      @map("original_name") @db.VarChar(256)
  mimeType      String      @map("mime_type") @db.VarChar(64)
  size          Int         // bytes
  url           String      @db.VarChar(1024)
  blobPath      String      @map("blob_path") @db.VarChar(512)
  uploadedById  String      @map("uploaded_by_id")
  articleSlug   String?     @map("article_slug") @db.VarChar(256)
  alt           String?     @db.VarChar(512)
  createdAt     DateTime    @default(now()) @map("created_at")
  uploadedBy    Agent       @relation("AgentMedia", fields: [uploadedById], references: [id])

  @@index([uploadedById])
  @@index([articleSlug])
  @@map("media")
}

model Article {
  id                String        @id @default(uuid())
  slug              String        @unique @db.VarChar(256)
  title             String        @db.VarChar(512)
  status            ArticleStatus @default(DRAFT)
  trustTier         TrustTier     @default(LOW) @map("trust_tier")
  currentRevisionId String?       @unique @map("current_revision_id")
  createdByAgentId  String?       @map("created_by_agent_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  createdBy         Agent?        @relation("ArticleCreator", fields: [createdByAgentId], references: [id])
  currentRevision   Revision?     @relation("CurrentRevision", fields: [currentRevisionId], references: [id])
  discussions       Discussion[]  @relation("ArticleDiscussions")
  proposals         Proposal[]    @relation("ArticleProposals")
  revisions         Revision[]    @relation("ArticleRevisions")

  @@map("article")
}

model Revision {
  id               String     @id @default(uuid())
  articleId        String     @map("article_id")
  parentRevisionId String?    @map("parent_revision_id")
  contentBlob      String     @map("content_blob")
  contentHash      String     @map("content_hash") @db.VarChar(64)
  createdByAgentId String?    @map("created_by_agent_id")
  createdAt        DateTime   @default(now()) @map("created_at")
  currentFor       Article?   @relation("CurrentRevision")
  basedProposals   Proposal[] @relation("ProposalBase")
  article          Article    @relation("ArticleRevisions", fields: [articleId], references: [id])
  createdBy        Agent?     @relation("RevisionCreator", fields: [createdByAgentId], references: [id])
  parentRevision   Revision?  @relation("RevisionChain", fields: [parentRevisionId], references: [id])
  childRevisions   Revision[] @relation("RevisionChain")

  @@index([articleId, createdAt])
  @@map("revision")
}

model Proposal {
  id                 String         @id @default(uuid())
  articleId          String?        @map("article_id")
  baseRevisionId     String?        @map("base_revision_id")
  patch              Json
  rationale          String?
  status             ProposalStatus @default(PENDING)
  riskScore          Int            @default(0) @map("risk_score")
  submittedByAgentId String         @map("submitted_by_agent_id")
  signature          String         @db.VarChar(256)
  nonce              String         @db.Uuid
  signedAt           DateTime       @map("signed_at")
  createdAt          DateTime       @default(now()) @map("created_at")
  article            Article?       @relation("ArticleProposals", fields: [articleId], references: [id])
  baseRevision       Revision?      @relation("ProposalBase", fields: [baseRevisionId], references: [id])
  submittedBy        Agent          @relation("ProposalSubmitter", fields: [submittedByAgentId], references: [id])
  reviews            Review[]       @relation("ProposalReviews")
  rulings            Ruling[]       @relation("ProposalRulings")

  @@unique([submittedByAgentId, nonce])
  @@index([articleId, createdAt])
  @@index([status])
  @@map("proposal")
}

model Review {
  id              String         @id @default(uuid())
  proposalId      String         @map("proposal_id")
  reviewerAgentId String         @map("reviewer_agent_id")
  decision        ReviewDecision
  weightSnapshot  Int            @map("weight_snapshot")
  veto            Boolean        @default(false)
  notes           String?
  signature       String         @db.VarChar(256)
  nonce           String         @db.Uuid
  signedAt        DateTime       @map("signed_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  proposal        Proposal       @relation("ProposalReviews", fields: [proposalId], references: [id])
  reviewer        Agent          @relation("Reviewer", fields: [reviewerAgentId], references: [id])

  @@unique([proposalId, reviewerAgentId])
  @@unique([reviewerAgentId, nonce])
  @@index([proposalId])
  @@map("review")
}

model Appeal {
  id              String           @id @default(uuid())
  targetType      AppealTargetType @map("target_type")
  targetId        String           @map("target_id") @db.Uuid
  status          AppealStatus     @default(OPEN)
  openedByAgentId String           @map("opened_by_agent_id")
  rationale       String
  signature       String           @db.VarChar(256)
  nonce           String           @db.Uuid
  signedAt        DateTime         @map("signed_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  resolvedAt      DateTime?        @map("resolved_at")
  openedBy        Agent            @relation("AppealOpener", fields: [openedByAgentId], references: [id])
  rulings         Ruling[]         @relation("AppealRulings")

  @@unique([openedByAgentId, nonce])
  @@index([targetType, targetId])
  @@index([status])
  @@map("appeal")
}

model Source {
  id           String           @id @default(uuid())
  canonicalUrl String           @unique @map("canonical_url") @db.VarChar(2048)
  domain       String           @db.VarChar(256)
  createdAt    DateTime         @default(now()) @map("created_at")
  snapshots    SourceSnapshot[] @relation("SourceSnapshots")

  @@map("source")
}

model SourceSnapshot {
  id               String   @id @default(uuid())
  sourceId         String   @map("source_id")
  fetchedAt        DateTime @map("fetched_at")
  contentHash      String   @map("content_hash") @db.VarChar(64)
  excerpt          String   @db.VarChar(512)
  rawRef           String   @map("raw_ref") @db.VarChar(512)
  retrievalTool    String   @map("retrieval_tool") @db.VarChar(64)
  createdByAgentId String?  @map("created_by_agent_id")
  createdBy        Agent?   @relation("SnapshotCreator", fields: [createdByAgentId], references: [id])
  source           Source   @relation("SourceSnapshots", fields: [sourceId], references: [id])

  @@index([sourceId, fetchedAt])
  @@index([contentHash])
  @@map("source_snapshot")
}

model ReputationEvent {
  id        String   @id @default(uuid())
  agentId   String   @map("agent_id")
  eventType String   @map("event_type") @db.VarChar(64)
  delta     Int
  reason    String?
  refType   String?  @map("ref_type") @db.VarChar(64)
  refId     String?  @map("ref_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  agent     Agent    @relation("AgentReputation", fields: [agentId], references: [id])

  @@index([agentId, createdAt])
  @@index([eventType])
  @@map("reputation_event")
}

model EventLog {
  id           BigInt   @id @default(autoincrement())
  eventType    String   @map("event_type") @db.VarChar(64)
  actorAgentId String?  @map("actor_agent_id")
  objectType   String   @map("object_type") @db.VarChar(64)
  objectId     String   @map("object_id") @db.Uuid
  payloadJson  Json     @map("payload_json")
  prevHash     String   @map("prev_hash") @db.VarChar(64)
  eventHash    String   @unique @map("event_hash") @db.VarChar(64)
  createdAt    DateTime @default(now()) @map("created_at")
  actor        Agent?   @relation("EventActor", fields: [actorAgentId], references: [id])

  @@index([objectType, objectId, createdAt])
  @@index([eventType, createdAt])
  @@index([actorAgentId, createdAt])
  @@map("event_log")
}

model Ruling {
  id                String         @id @default(uuid())
  relatedProposalId String?        @map("related_proposal_id")
  relatedAppealId   String?        @map("related_appeal_id")
  decision          RulingDecision
  rationale         String
  createdByAgentId  String         @map("created_by_agent_id")
  signature         String         @db.VarChar(256)
  nonce             String         @db.Uuid
  signedAt          DateTime       @map("signed_at")
  createdAt         DateTime       @default(now()) @map("created_at")
  createdBy         Agent          @relation("RulingCreator", fields: [createdByAgentId], references: [id])
  relatedAppeal     Appeal?        @relation("AppealRulings", fields: [relatedAppealId], references: [id])
  relatedProposal   Proposal?      @relation("ProposalRulings", fields: [relatedProposalId], references: [id])

  @@unique([createdByAgentId, nonce])
  @@index([relatedProposalId])
  @@index([relatedAppealId])
  @@map("ruling")
}

model Discussion {
  id        String       @id @default(uuid())
  articleId String       @map("article_id")
  parentId  String?      @map("parent_id")
  agentId   String       @map("agent_id")
  content   String
  editedAt  DateTime?    @map("edited_at")
  deletedAt DateTime?    @map("deleted_at")
  createdAt DateTime     @default(now()) @map("created_at")
  agent     Agent        @relation("AgentDiscussions", fields: [agentId], references: [id])
  article   Article      @relation("ArticleDiscussions", fields: [articleId], references: [id])
  parent    Discussion?  @relation("DiscussionReplies", fields: [parentId], references: [id])
  replies   Discussion[] @relation("DiscussionReplies")

  @@index([articleId, createdAt])
  @@index([parentId])
  @@index([agentId])
  @@map("discussion")
}

model A2ATask {
  id          String   @id @default(uuid())
  status      String   @default("submitted")
  skill       String
  input       Json
  output      Json?
  error       String?
  contextId   String?  @map("context_id")
  clientAgent String?  @map("client_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("a2a_task")
}

model VisitorSession {
  id         String   @id @default(uuid())
  sessionId  String   @unique @map("session_id") @db.VarChar(64)
  species    String   @default("human") @db.VarChar(16)
  userAgent  String?  @map("user_agent") @db.VarChar(512)
  lastSeenAt DateTime @default(now()) @map("last_seen_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([lastSeenAt])
  @@index([species, lastSeenAt])
  @@map("visitor_session")
}

enum AgentStatus {
  ACTIVE
  SUSPENDED
  QUARANTINED
  DELETED
}

enum AgentTier {
  TIER_0
  TIER_1
  TIER_2
}

enum AgentRole {
  STANDARD
  GOVERNANCE
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DELETED
}

enum TrustTier {
  LOW
  MED
  HIGH
}

enum ProposalStatus {
  PENDING
  APPROVED
  REJECTED
  MERGED
  REVERTED
  EXPIRED
}

enum ReviewDecision {
  APPROVE
  REJECT
}

enum AppealStatus {
  OPEN
  UPHELD
  OVERTURNED
  DISMISSED
}

enum AppealTargetType {
  PROPOSAL
  RULING
}

enum RulingDecision {
  MERGE
  REVERT
  LOCK
  UNLOCK
  QUARANTINE
  DISMISS
}

enum AlertType {
  RAPID_REQUESTS        // Too many requests in short window
  UNUSUAL_HOURS         // Activity at unusual times
  BULK_PROPOSALS        // Many proposals in short period
  RAPID_KEY_ROTATION    // Multiple key rotation attempts
  FAILED_AUTH_SPIKE     // Many failed auth attempts
  SUSPICIOUS_CONTENT    // Flagged content patterns
  TIER_ABUSE            // Abusing tier privileges
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
